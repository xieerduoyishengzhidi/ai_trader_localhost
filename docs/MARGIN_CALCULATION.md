# ä¿è¯é‡‘è®¡ç®—ä¸AIä¿¡æ¯ä¼ é€’

## ğŸ“Š ä¿è¯é‡‘è®¡ç®—æ–¹å¼

### 1. å•ä¸ªæŒä»“ä¿è¯é‡‘è®¡ç®—

**ä½ç½®**: `trader/auto_trader.go:729` å’Œ `trader/auto_trader.go:1118`

```go
// è®¡ç®—å…¬å¼
marginUsed := (quantity * markPrice) / float64(leverage)
```

**è¯´æ˜**:
- `quantity`: æŒä»“æ•°é‡ï¼ˆå·²å¤„ç†ç©ºä»“è´Ÿæ•°ï¼‰
- `markPrice`: æ ‡è®°ä»·æ ¼ï¼ˆå½“å‰å¸‚ä»·ï¼‰
- `leverage`: æ æ†å€æ•°ï¼ˆä»æŒä»“ä¿¡æ¯è·å–ï¼Œé»˜è®¤10ï¼‰

**ç¤ºä¾‹**:
- æŒä»“æ•°é‡: 1 BTC
- æ ‡è®°ä»·æ ¼: 50000 USDT
- æ æ†å€æ•°: 10x
- ä¿è¯é‡‘ = (1 Ã— 50000) / 10 = 5000 USDT

### 2. æ€»ä¿è¯é‡‘ä½¿ç”¨ç‡è®¡ç®—

**ä½ç½®**: `trader/auto_trader.go:778` å’Œ `trader/auto_trader.go:1130`

```go
// æ€»ä¿è¯é‡‘ = æ‰€æœ‰æŒä»“ä¿è¯é‡‘ä¹‹å’Œ
totalMarginUsed := sum(marginUsed for each position)

// ä¿è¯é‡‘ä½¿ç”¨ç‡
marginUsedPct := (totalMarginUsed / totalEquity) * 100
```

**è¯´æ˜**:
- `totalEquity`: è´¦æˆ·å‡€å€¼ = `totalWalletBalance + totalUnrealizedProfit`
- ä½¿ç”¨ç‡è¶…è¿‡90%æ—¶ç³»ç»Ÿä¼šé™åˆ¶æ–°å¼€ä»“ï¼ˆè§ `decision/engine.go:734`ï¼‰

### 3. å‰©ä½™å¯ç”¨ä¿è¯é‡‘è®¡ç®—

**ä½ç½®**: `trader/auto_trader.go:781` å’Œ `trader/auto_trader.go:1140`

```go
// å‰©ä½™å¯ç”¨ä¿è¯é‡‘ = è´¦æˆ·å‡€å€¼ - å·²ç”¨ä¿è¯é‡‘
availableMargin := totalEquity - totalMarginUsed
if availableMargin < 0 {
    availableMargin = 0 // ç¡®ä¿ä¸ä¸ºè´Ÿæ•°
}
```

**è¯´æ˜**:
- å‰©ä½™å¯ç”¨ä¿è¯é‡‘è¡¨ç¤ºè¿˜å¯ä»¥ç”¨äºå¼€æ–°ä»“çš„ä¿è¯é‡‘é¢åº¦
- å¦‚æœè®¡ç®—ç»“æœä¸ºè´Ÿæ•°ï¼Œä¼šè¢«è®¾ç½®ä¸º0ï¼ˆé˜²æ­¢å¼‚å¸¸æƒ…å†µï¼‰

## ğŸ“¤ ä¼ é€’ç»™AIçš„ä¿è¯é‡‘ä¿¡æ¯

### 1. è´¦æˆ·çº§åˆ«ä¿¡æ¯

**ä½ç½®**: `decision/engine.go:1096` å’Œ `decision/engine.go:1257`

**æ ¼å¼**:
```
**è´¦æˆ·**: å‡€å€¼{TotalEquity} | ä½™é¢{AvailableBalance} ({ä½™é¢å æ¯”}%) | ç›ˆäº{TotalPnLPct}% | ä¿è¯é‡‘{MarginUsedPct}% (å·²ç”¨{MarginUsed}/å¯ç”¨{AvailableMargin}) | æŒä»“{PositionCount}ä¸ª
```

**å­—æ®µè¯´æ˜**:
- `MarginUsedPct`: ä¿è¯é‡‘ä½¿ç”¨ç‡ï¼ˆç™¾åˆ†æ¯”ï¼‰
- `MarginUsed`: å·²ç”¨ä¿è¯é‡‘é‡‘é¢ï¼ˆUSDTï¼‰
- `AvailableMargin`: å‰©ä½™å¯ç”¨ä¿è¯é‡‘é‡‘é¢ï¼ˆUSDTï¼‰
- ç¤ºä¾‹: `ä¿è¯é‡‘45.2% (å·²ç”¨45200/å¯ç”¨54800)` è¡¨ç¤ºå·²ç”¨ä¿è¯é‡‘å è´¦æˆ·å‡€å€¼çš„45.2%ï¼Œå·²ç”¨45200 USDTï¼Œå‰©ä½™å¯ç”¨54800 USDT

### 2. æŒä»“çº§åˆ«ä¿¡æ¯

**ä½ç½®**: `decision/engine.go:1122` å’Œ `decision/engine.go:1283`

**æ ¼å¼**:
```
{åºå·}. {Symbol} {SIDE} | å…¥åœºä»·{EntryPrice} å½“å‰ä»·{MarkPrice} | ç›ˆäº{UnrealizedPnLPct}% | æ æ†{Leverage}x | ä¿è¯é‡‘{MarginUsed} | å¼ºå¹³ä»·{LiquidationPrice}
```

**å­—æ®µè¯´æ˜**:
- `MarginUsed`: è¯¥æŒä»“å ç”¨çš„ä¿è¯é‡‘é‡‘é¢ï¼ˆUSDTï¼‰
- ç¤ºä¾‹: `ä¿è¯é‡‘5000` è¡¨ç¤ºè¯¥æŒä»“å ç”¨5000 USDTä¿è¯é‡‘

### 3. System Promptä¸­çš„ä¿è¯é‡‘çº¦æŸ

**ä½ç½®**: `decision/engine.go:734` å’Œ `decision/engine.go:813`

**çº¦æŸè§„åˆ™**:
- æ€»ä¿è¯é‡‘ä½¿ç”¨ç‡ â‰¤ 90%ï¼ˆç¡¬çº¦æŸï¼‰
- æ€»ä¿è¯é‡‘ä½¿ç”¨ç‡ â‰¤ 60%ï¼ˆå»ºè®®å€¼ï¼‰
- ä¿è¯é‡‘ä½¿ç”¨ç‡ > 50% æ—¶ï¼Œç³»ç»Ÿä¼šæ‹’ç»æ–°å¼€ä»“ï¼ˆè§ `decision/engine.go:1678`ï¼‰

## ğŸ” ä»£ç ä½ç½®æ€»ç»“

| åŠŸèƒ½ | æ–‡ä»¶ä½ç½® | è¡Œå· |
|------|---------|------|
| å•ä¸ªæŒä»“ä¿è¯é‡‘è®¡ç®— | `trader/auto_trader.go` | 729, 1118 |
| æ€»ä¿è¯é‡‘ä½¿ç”¨ç‡è®¡ç®— | `trader/auto_trader.go` | 778, 1130 |
| å‰©ä½™å¯ç”¨ä¿è¯é‡‘è®¡ç®— | `trader/auto_trader.go` | 781, 1140 |
| è´¦æˆ·ä¿è¯é‡‘ä¿¡æ¯è¾“å‡º | `decision/engine.go` | 1096, 1257 |
| æŒä»“ä¿è¯é‡‘ä¿¡æ¯è¾“å‡º | `decision/engine.go` | 1122, 1283 |
| ä¿è¯é‡‘çº¦æŸæ£€æŸ¥ | `decision/engine.go` | 1678 |

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ä¿è¯é‡‘è®¡ç®—åŸºäºæ ‡è®°ä»·æ ¼**: ä½¿ç”¨ `markPrice` è€Œé `entryPrice`ï¼Œç¡®ä¿å®æ—¶åæ˜ å½“å‰å¸‚åœºä»·å€¼
2. **æ æ†ä»æŒä»“è·å–**: ä¼˜å…ˆä½¿ç”¨æŒä»“ä¿¡æ¯ä¸­çš„æ æ†ï¼Œé»˜è®¤å€¼ä¸º10
3. **ç©ºä»“å¤„ç†**: ç©ºä»“æ•°é‡ä¸ºè´Ÿæ•°ï¼Œè®¡ç®—å‰ä¼šè½¬ä¸ºæ­£æ•°
4. **å…¨ä»“æ¨¡å¼**: å½“å‰ç³»ç»Ÿä½¿ç”¨å…¨ä»“æ¨¡å¼ï¼ˆè§ `trader/hyperliquid_trader.go:81`ï¼‰

