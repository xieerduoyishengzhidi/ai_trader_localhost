name: æ¯æ—¥ Telegram ç¾¤ç»„æ‘˜è¦

on:
  schedule:
    # æ¯å¤© UTC 23:00 è¿è¡Œï¼ˆä¸­å›½æ—¶é—´æ—©ä¸Š 7:00ï¼ŒUTC+8ï¼‰
    # å¦‚éœ€è°ƒæ•´æ—¶é—´ï¼Œä¿®æ”¹ cron è¡¨è¾¾å¼ï¼šåˆ†é’Ÿ å°æ—¶ æ—¥ æœˆ æ˜ŸæœŸ
    # ä¾‹å¦‚ï¼š'0 7 * * *' è¡¨ç¤ºæ¯å¤© UTC 7:00ï¼ˆä¸­å›½æ—¶é—´ 15:00ï¼‰
    - cron: '0 23 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  fetch-and-summarize:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: å®‰è£…ä¾èµ–
        working-directory: telegramæ’ä»¶
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: æ¢å¤ Telegram Session æ–‡ä»¶
        working-directory: telegramæ’ä»¶
        env:
          TELEGRAM_SESSION: ${{ secrets.TELEGRAM_SESSION }}
        run: |
          if [ -n "$TELEGRAM_SESSION" ]; then
            echo "$TELEGRAM_SESSION" | base64 -d > telegram_session.session
            echo "âœ… Session æ–‡ä»¶å·²æ¢å¤"
          else
            echo "âš ï¸ æœªé…ç½® TELEGRAM_SESSION secretï¼Œå°†éœ€è¦é¦–æ¬¡ç™»å½•"
          fi

      - name: è¿è¡Œ Telegram æ¶ˆæ¯æŠ“å–å’Œæ‘˜è¦
        working-directory: telegramæ’ä»¶

        run: |
          # è®¾ç½®é»˜è®¤å€¼
          TELEGRAM_CHAT="${{ secrets.TELEGRAM_CHAT }}"
          TELEGRAM_LIMIT="${{ secrets.TELEGRAM_LIMIT }}"
          if [ -z "$TELEGRAM_CHAT" ]; then
            TELEGRAM_CHAT="nofx_dev_community"
          fi
          if [ -z "$TELEGRAM_LIMIT" ]; then
            TELEGRAM_LIMIT="2000"
          fi
          python fetch_tg_ai.py --chat "$TELEGRAM_CHAT" --limit "$TELEGRAM_LIMIT"
          
          # æ£€æŸ¥è¾“å‡ºæ–‡ä»¶
          if [ -d "output" ]; then
            echo "è¾“å‡ºæ–‡ä»¶å·²ç”Ÿæˆ"
            ls -la output/
          fi

      - name: ä¸Šä¼ è¾“å‡ºæ–‡ä»¶
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: telegram-summary-${{ github.run_number }}
          path: telegramæ’ä»¶/output/*
          retention-days: 30

      - name: å‘é€ Telegram é€šçŸ¥
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # æ„å»ºé€šçŸ¥æ¶ˆæ¯
          if [ "${{ job.status }}" == "success" ]; then
            STATUS_EMOJI="âœ…"
            STATUS_TEXT="æˆåŠŸ"
            # è¯»å–æœ€æ–°çš„æ‘˜è¦æ–‡ä»¶
            LATEST_SUMMARY=$(ls -t telegramæ’ä»¶/output/summary_*.txt 2>/dev/null | head -1)
            if [ -n "$LATEST_SUMMARY" ]; then
              # è·å–æ‘˜è¦çš„å‰800å­—ç¬¦ä½œä¸ºé¢„è§ˆï¼ˆé¿å…æ¶ˆæ¯è¿‡é•¿ï¼‰
              SUMMARY_PREVIEW=$(head -c 800 "$LATEST_SUMMARY" | sed 's/\\/\\\\/g' | sed 's/"/\\"/g' | sed 's/`/\\`/g' | sed 's/*/\\*/g' | sed 's/_/\\_/g' | sed 's/\[/\\[/g' | sed 's/\]/\\]/g')
              MESSAGE="*æ¯æ—¥ Telegram ç¾¤ç»„æ‘˜è¦*

${STATUS_EMOJI} çŠ¶æ€: ${STATUS_TEXT}

ğŸ“„ æ‘˜è¦é¢„è§ˆ:
\`\`\`
${SUMMARY_PREVIEW}...
\`\`\`

ğŸ“Š å®Œæ•´æ‘˜è¦å·²ä¸Šä¼ åˆ° GitHub Actions Artifacts
ğŸ”— æŸ¥çœ‹: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            else
              MESSAGE="*æ¯æ—¥ Telegram ç¾¤ç»„æ‘˜è¦*

${STATUS_EMOJI} çŠ¶æ€: ${STATUS_TEXT}

âš ï¸ æœªæ‰¾åˆ°æ‘˜è¦æ–‡ä»¶"
            fi
          else
            STATUS_EMOJI="âŒ"
            STATUS_TEXT="å¤±è´¥"
            MESSAGE="*æ¯æ—¥ Telegram ç¾¤ç»„æ‘˜è¦*

${STATUS_EMOJI} çŠ¶æ€: ${STATUS_TEXT}

è¯·æŸ¥çœ‹ GitHub Actions æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯
ğŸ”— æŸ¥çœ‹: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi
          
          # å‘é€é€šçŸ¥åˆ° Telegram
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            # ä½¿ç”¨ Python å‘é€æ¶ˆæ¯ï¼Œé¿å… shell è½¬ä¹‰é—®é¢˜
            python3 << EOF
import os
import requests
import json

bot_token = os.getenv('TELEGRAM_BOT_TOKEN')
chat_id = os.getenv('TELEGRAM_CHAT_ID')
message = """$MESSAGE"""

url = f"https://api.telegram.org/bot{bot_token}/sendMessage"
payload = {
    "chat_id": chat_id,
    "text": message,
    "parse_mode": "Markdown",
    "disable_web_page_preview": True
}

response = requests.post(url, json=payload)
if response.status_code == 200:
    print("âœ… Telegram é€šçŸ¥å‘é€æˆåŠŸ")
else:
    print(f"âš ï¸ å‘é€å¤±è´¥: {response.status_code} - {response.text}")
EOF
          else
            echo "âš ï¸ æœªé…ç½® Telegram Bot Token æˆ– Chat IDï¼Œè·³è¿‡é€šçŸ¥"
          fi

