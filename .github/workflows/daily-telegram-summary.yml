name: æ¯æ—¥ Telegram ç¾¤ç»„æ‘˜è¦

on:
  schedule:
    # æ¯å¤© UTC 23:00 è¿è¡Œï¼ˆä¸­å›½æ—¶é—´æ—©ä¸Š 7:00ï¼ŒUTC+8ï¼‰
    # å¦‚éœ€è°ƒæ•´æ—¶é—´ï¼Œä¿®æ”¹ cron è¡¨è¾¾å¼ï¼šåˆ†é’Ÿ å°æ—¶ æ—¥ æœˆ æ˜ŸæœŸ
    # ä¾‹å¦‚ï¼š'0 7 * * *' è¡¨ç¤ºæ¯å¤© UTC 7:00ï¼ˆä¸­å›½æ—¶é—´ 15:00ï¼‰
    - cron: '0 23 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  fetch-and-summarize:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: å®‰è£…ä¾èµ–
        working-directory: telegramæ’ä»¶
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: æ¢å¤ Telegram Session æ–‡ä»¶
        working-directory: telegramæ’ä»¶
        env:
          TELEGRAM_SESSION: ${{ secrets.TELEGRAM_SESSION }}
        run: |
          if [ -n "$TELEGRAM_SESSION" ]; then
            echo "$TELEGRAM_SESSION" | base64 -d > telegram_session.session
            echo "âœ… Session æ–‡ä»¶å·²æ¢å¤"
          else
            echo "âš ï¸ æœªé…ç½® TELEGRAM_SESSION secretï¼Œå°†éœ€è¦é¦–æ¬¡ç™»å½•"
          fi

      - name: è¿è¡Œ Telegram æ¶ˆæ¯æŠ“å–å’Œæ‘˜è¦
        working-directory: telegramæ’ä»¶
        env:
          TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
          TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          TELEGRAM_CHAT: ${{ secrets.TELEGRAM_CHAT || 'nofx_dev_community' }}
          TELEGRAM_LIMIT: ${{ secrets.TELEGRAM_LIMIT || '2000' }}
        run: |
          python fetch_tg_ai.py --chat "$TELEGRAM_CHAT" --limit "$TELEGRAM_LIMIT"
          
          # æ£€æŸ¥è¾“å‡ºæ–‡ä»¶
          if [ -d "output" ]; then
            echo "è¾“å‡ºæ–‡ä»¶å·²ç”Ÿæˆ"
            ls -la output/
          fi

      - name: ä¸Šä¼ è¾“å‡ºæ–‡ä»¶
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: telegram-summary-${{ github.run_number }}
          path: telegramæ’ä»¶/output/*
          retention-days: 30

      - name: å‘é€ Telegram é€šçŸ¥
        if: always()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            STATUS_EMOJI="âœ…"
            STATUS_TEXT="æˆåŠŸ"
            # è¯»å–æœ€æ–°çš„æ‘˜è¦æ–‡ä»¶
            LATEST_SUMMARY=$(ls -t telegramæ’ä»¶/output/summary_*.txt 2>/dev/null | head -1)
            if [ -n "$LATEST_SUMMARY" ]; then
              # è·å–æ‘˜è¦çš„å‰500å­—ç¬¦ä½œä¸ºé¢„è§ˆ
              SUMMARY_PREVIEW=$(head -c 500 "$LATEST_SUMMARY" | sed 's/"/\\"/g')
              MESSAGE="*æ¯æ—¥ Telegram ç¾¤ç»„æ‘˜è¦*\n\n${STATUS_EMOJI} çŠ¶æ€: ${STATUS_TEXT}\n\nğŸ“„ æ‘˜è¦é¢„è§ˆ:\n\`\`\`\n${SUMMARY_PREVIEW}...\n\`\`\`\n\nğŸ“Š å®Œæ•´æ‘˜è¦å·²ä¸Šä¼ åˆ° GitHub Actions Artifacts"
            else
              MESSAGE="*æ¯æ—¥ Telegram ç¾¤ç»„æ‘˜è¦*\n\n${STATUS_EMOJI} çŠ¶æ€: ${STATUS_TEXT}\n\nâš ï¸ æœªæ‰¾åˆ°æ‘˜è¦æ–‡ä»¶"
            fi
          else
            STATUS_EMOJI="âŒ"
            STATUS_TEXT="å¤±è´¥"
            MESSAGE="*æ¯æ—¥ Telegram ç¾¤ç»„æ‘˜è¦*\n\n${STATUS_EMOJI} çŠ¶æ€: ${STATUS_TEXT}\n\nè¯·æŸ¥çœ‹ GitHub Actions æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯"
          fi
          
          # å‘é€é€šçŸ¥åˆ° Telegram
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${TELEGRAM_CHAT_ID}" \
              -d "text=${MESSAGE}" \
              -d "parse_mode=Markdown" \
              -d "disable_web_page_preview=true"
          else
            echo "âš ï¸ æœªé…ç½® Telegram Bot Token æˆ– Chat IDï¼Œè·³è¿‡é€šçŸ¥"
          fi

