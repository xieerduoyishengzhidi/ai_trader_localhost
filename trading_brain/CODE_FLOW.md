# Trading Brain ä»£ç æµç¨‹è¯¦è§£

## ğŸ”„ æ•´ä½“æ‰§è¡Œæµç¨‹

```
main()
  â”‚
  â”œâ”€ 1. æ£€æŸ¥ Macro Service è¿æ¥
  â”‚   â””â”€ GET /health
  â”‚
  â”œâ”€ 2. åˆ›å»º Pentosh1DataAggregator
  â”‚
  â”œâ”€ 3. è°ƒç”¨ aggregate_all_data("BTC/USDT")
  â”‚   â”‚
  â”‚   â”œâ”€ 3.1 get_layer1_global_liquidity()
  â”‚   â”‚   â”‚
  â”‚   â”‚   â”œâ”€ FRED API è°ƒç”¨ï¼ˆ30-60å¤©èŒƒå›´ï¼‰
  â”‚   â”‚   â”‚   â”œâ”€ WALCL (30å¤©)
  â”‚   â”‚   â”‚   â”œâ”€ WTREGEN (30å¤©)
  â”‚   â”‚   â”‚   â”œâ”€ RRPONTSYD (30å¤©)
  â”‚   â”‚   â”‚   â”œâ”€ DGS2 (60å¤©)
  â”‚   â”‚   â”‚   â””â”€ T10Y2Y (60å¤©)
  â”‚   â”‚   â”‚
  â”‚   â”‚   â”œâ”€ yfinance API è°ƒç”¨ï¼ˆ3ä¸ªæœˆå‘¨æœŸï¼‰
  â”‚   â”‚   â”‚   â”œâ”€ DX-Y.NYB (DXY)
  â”‚   â”‚   â”‚   â”œâ”€ ^TNX (US10Y)
  â”‚   â”‚   â”‚   â”œâ”€ ^GSPC (SPX)
  â”‚   â”‚   â”‚   â”œâ”€ ^NDX (NDX)
  â”‚   â”‚   â”‚   â””â”€ CNH=X (CNY)
  â”‚   â”‚   â”‚
  â”‚   â”‚   â””â”€ _calculate_macro_score()
  â”‚   â”‚       â””â”€ è®¡ç®—å®è§‚è¯„åˆ† (0-100)
  â”‚   â”‚
  â”‚   â”œâ”€ 3.2 get_layer2_4_crypto_data("BTC/USDT")
  â”‚   â”‚   â”‚
  â”‚   â”‚   â””â”€ POST /api/crypto/all
  â”‚   â”‚       â”œâ”€ Binance API (èµ„é‡‘è´¹ç‡ã€OIã€å¤šç©ºæ¯”)
  â”‚   â”‚       â”œâ”€ Farside (ETFæ•°æ®)
  â”‚   â”‚       â”œâ”€ DeFi Llama (ç¨³å®šå¸)
  â”‚   â”‚       â”œâ”€ CoinGecko (BTC.Dã€TOTAL3)
  â”‚   â”‚       â””â”€ Alternative.me (ææƒ§è´ªå©ªæŒ‡æ•°)
  â”‚   â”‚
  â”‚   â””â”€ 3.3 _generate_pentosh1_signals()
  â”‚       â””â”€ ç”Ÿæˆäº¤æ˜“ä¿¡å·
  â”‚
  â”œâ”€ 4. save_daily_context()
  â”‚   â””â”€ ä¿å­˜ä¸º Daily_Context_YYYY-MM-DD.json
  â”‚
  â””â”€ 5. æ‰“å°æ‘˜è¦ä¿¡æ¯
```

---

## ğŸ“… æ—¥æœŸå’Œæ—¶é—´è®¾ç½®è¯¦è§£

### ä¸»æ•°æ®åŒ…æ—¥æœŸ

```python
# ç¬¬324è¡Œ
"date": datetime.now().strftime("%Y-%m-%d")
```

**é€»è¾‘**:
- ä½¿ç”¨**å½“å‰ç³»ç»Ÿæ—¶é—´**
- æ ¼å¼: `YYYY-MM-DD`
- **ä¸ä¾èµ–æ•°æ®æºæ—¥æœŸ**ï¼Œå§‹ç»ˆä½¿ç”¨è¿è¡Œæ—¶çš„æ—¥æœŸ

**ç¤ºä¾‹**:
- è¿è¡Œæ—¶é—´: 2025-12-06 16:06:15
- `date` = `"2025-12-06"`
- æ–‡ä»¶å: `Daily_Context_2025-12-06.json`

---

### ç¬¬ä¸€å±‚çº§æ—¶é—´è®¾ç½®

#### FRED API æ•°æ®æŸ¥è¯¢èŒƒå›´

**Fed Net Liquidity (WALCL, TGA, RRP)**:
```python
# ç¬¬68-69è¡Œ
start_date = (datetime.now() - timedelta(days=30)).strftime("%Y-%m-%d")
end_date = datetime.now().strftime("%Y-%m-%d")
```
- **èŒƒå›´**: 30å¤©å‰ â†’ ä»Šå¤©
- **åŸå› **: FREDå‘¨é¢‘æ•°æ®ï¼Œ30å¤©è¶³å¤Ÿè·å–4-5ä¸ªæ•°æ®ç‚¹
- **è·å–**: å– `data[-1]`ï¼ˆæœ€åä¸€ä¸ªï¼Œå³æœ€æ–°å€¼ï¼‰

**US02Y & Yield Curve**:
```python
# ç¬¬141-142è¡Œ, 162-163è¡Œ
start_date = (datetime.now() - timedelta(days=60)).strftime("%Y-%m-%d")
end_date = datetime.now().strftime("%Y-%m-%d")
```
- **èŒƒå›´**: 60å¤©å‰ â†’ ä»Šå¤©
- **åŸå› **: æ—¥é¢‘æ•°æ®ï¼Œ60å¤©ç¡®ä¿æœ‰è¶³å¤Ÿæ•°æ®ç‚¹
- **è·å–**: å– `data[-1]`ï¼ˆæœ€åä¸€ä¸ªï¼Œå³æœ€æ–°å€¼ï¼‰

#### yfinance æ•°æ®æŸ¥è¯¢èŒƒå›´

**æ‰€æœ‰yfinanceæŒ‡æ ‡**:
```python
# ç¬¬105è¡Œ, 124è¡Œ, 185è¡Œç­‰
period = "3mo"  # 3ä¸ªæœˆ
interval = "1d"  # æ—¥çº¿
```
- **èŒƒå›´**: 3ä¸ªæœˆå‰ â†’ ä»Šå¤©
- **åŸå› **: 
  - é¿å…å‘¨æœ«/èŠ‚å‡æ—¥æ•°æ®ç¼ºå¤±
  - 3ä¸ªæœˆçº¦90ä¸ªäº¤æ˜“æ—¥ï¼Œæ•°æ®å……è¶³
- **è·å–**: å– `data[-1]`ï¼ˆæœ€åä¸€ä¸ªï¼Œå³æœ€æ–°å€¼ï¼‰

---

### ç¬¬äºŒå±‚çº§æ—¶é—´è®¾ç½®

**Stablecoin Market Cap**:
- **æ—¶é—´**: å®æ—¶ï¼ˆå½“å‰å€¼ï¼‰
- **æ— å†å²æŸ¥è¯¢**: åªè·å–å½“å‰æ€»å¸‚å€¼

**ETF Net Inflow**:
- **æ—¶é—´**: T+1ï¼ˆæ˜¨å¤©çš„æ•°æ®ï¼‰
- **æ•°æ®æº**: Farside.co.uk ç½‘é¡µè¡¨æ ¼
- **è·å–**: è¡¨æ ¼æœ€åä¸€è¡Œï¼ˆæœ€æ–°æ•°æ®ï¼‰

**æ³¨æ„**: 
- ETFæ•°æ®æ˜¯T+1çš„
- å¦‚æœä»Šå¤©æ˜¯å‘¨ä¸€ï¼Œè·å–çš„æ˜¯ä¸Šå‘¨äº”çš„æ•°æ®
- å¦‚æœä»Šå¤©æ˜¯å‘¨æœ«ï¼Œå¯èƒ½è·å–åˆ°å‘¨äº”çš„æ•°æ®

---

### ç¬¬ä¸‰ã€å››å±‚çº§æ—¶é—´è®¾ç½®

**æ‰€æœ‰å¸åœˆå®æ—¶æ•°æ®**:
- **æ—¶é—´**: å®æ—¶ï¼ˆå½“å‰å€¼ï¼‰
- **æ— å†å²æŸ¥è¯¢**: åªè·å–å½“å‰å¿«ç…§
- **æ•°æ®æº**: Binance API, CoinGecko, Alternative.me

---

## ğŸ” æ•°æ®è·å–å’Œå¡«å……é€»è¾‘

### æ•°æ®è·å–æµç¨‹

```python
# 1. è°ƒç”¨API
data = self._call_api("/api/fred/series", "POST", {...})

# 2. æ£€æŸ¥å“åº”
if data and data.get("data") and len(data["data"]) > 0:
    # 3. è·å–æœ€æ–°å€¼
    latest = data["data"][-1]  # æ•°ç»„æœ€åä¸€ä¸ª
    value = latest.get("value")
    
    # 4. æ£€æŸ¥å€¼æ˜¯å¦ä¸ºNone
    if value is not None:
        # 5. ä¿å­˜æ•°æ®
        indicators["xxx"] = {"value": value, ...}
    else:
        # å€¼æ— æ•ˆï¼Œè·³è¿‡ï¼ˆä¸å¡«å……ï¼‰
        pass
else:
    # APIå¤±è´¥æˆ–æ•°æ®ä¸ºç©ºï¼Œè·³è¿‡ï¼ˆä¸å¡«å……ï¼‰
    pass
```

### å¡«å……ç­–ç•¥

**å½“å‰å®ç°**: âŒ **æ— å¡«å……**

- å¦‚æœAPIè°ƒç”¨å¤±è´¥ â†’ `indicators` å­—å…¸ä¸­ä¸åŒ…å«è¯¥æŒ‡æ ‡
- å¦‚æœæ•°æ®ä¸ºç©º â†’ è·³è¿‡ï¼Œä¸ä¿å­˜
- å¦‚æœå€¼ä¸ºNone â†’ è·³è¿‡ï¼Œä¸ä¿å­˜

**ç¤ºä¾‹**:
```json
{
  "indicators": {
    "dxy": {"value": 102.5, ...},      // âœ… æˆåŠŸ
    // "us10y": ç¼ºå¤±                    // âŒ å¤±è´¥ï¼Œä¸å¡«å……
    "yield_curve": {"value": -0.3, ...} // âœ… æˆåŠŸ
  }
}
```

---

## ğŸ“Š æ•°æ®æ—¶é—´å¯¹é½é—®é¢˜

### é—®é¢˜è¯´æ˜

ä¸åŒæ•°æ®æºçš„æ—¶é—´å¯èƒ½ä¸ä¸€è‡´ï¼š

| æ•°æ®æº | æ•°æ®æ—¥æœŸ | ç¤ºä¾‹ |
|--------|---------|------|
| FRED (WALCL) | å¯èƒ½å»¶è¿Ÿ3-7å¤© | 2025-11-29 |
| yfinance (DXY) | å®æ—¶ï¼ˆä»Šå¤©ï¼‰ | 2025-12-06 |
| ETFæ•°æ® | T+1ï¼ˆæ˜¨å¤©ï¼‰ | 2025-12-05 |
| Binanceæ•°æ® | å®æ—¶ï¼ˆç°åœ¨ï¼‰ | 2025-12-06 16:06 |

### å½“å‰å¤„ç†æ–¹å¼

**ä¸è¿›è¡Œæ—¶é—´å¯¹é½**:
- æ¯ä¸ªæŒ‡æ ‡ä½¿ç”¨å„è‡ªçš„æœ€æ–°å¯ç”¨å€¼
- ä¸å¼ºåˆ¶è¦æ±‚æ‰€æœ‰æ•°æ®éƒ½æ˜¯åŒä¸€å¤©çš„
- æ¥å—æ—¶é—´å·®å¼‚ï¼ˆè¿™æ˜¯æ­£å¸¸çš„ï¼‰

**åŸå› **:
- FREDæ•°æ®æœ¬èº«å°±æœ‰å»¶è¿Ÿ
- ETFæ•°æ®æ˜¯T+1çš„
- å®æ—¶æ•°æ®æ˜¯å½“å‰æ—¶åˆ»çš„å¿«ç…§

---

## ğŸ¯ å…³é”®ä»£ç ä½ç½®

### æ—¥æœŸè®¾ç½®

```python
# ä¸»æ•°æ®åŒ…æ—¥æœŸ (ç¬¬324è¡Œ)
"date": datetime.now().strftime("%Y-%m-%d")

# Layer1æ—¶é—´æˆ³ (ç¬¬60è¡Œ)
"timestamp": datetime.now().isoformat()

# FREDæŸ¥è¯¢èŒƒå›´ (ç¬¬68-69è¡Œ, 141-142è¡Œ)
start_date = (datetime.now() - timedelta(days=30)).strftime("%Y-%m-%d")
end_date = datetime.now().strftime("%Y-%m-%d")

# yfinanceæŸ¥è¯¢èŒƒå›´ (ç¬¬105è¡Œç­‰)
period = "3mo"
interval = "1d"
```

### æ•°æ®æå–

```python
# è·å–æœ€æ–°å€¼ (ç¬¬84-86è¡Œç­‰)
latest = data["data"][-1]  # æ•°ç»„æœ€åä¸€ä¸ªå…ƒç´ 
value = latest.get("value")
```

### æ•°æ®ä¿å­˜

```python
# ä¿å­˜åˆ°indicators (ç¬¬90-97è¡Œç­‰)
layer1["indicators"]["fed_net_liquidity"] = {
    "value": net_liquidity,
    "signal": "bullish" if net_liquidity > 0 else "bearish",
    ...
}
```

---

## ğŸ’¡ æ”¹è¿›å»ºè®®

### 1. æ·»åŠ æ•°æ®æ—¥æœŸè®°å½•

```python
# è®°å½•æ¯ä¸ªæŒ‡æ ‡çš„å®é™…æ•°æ®æ—¥æœŸ
layer1["indicators"]["fed_net_liquidity"] = {
    "value": net_liquidity,
    "data_date": latest.get("date"),  # æ·»åŠ æ•°æ®æ—¥æœŸ
    "signal": "bullish",
    ...
}
```

### 2. æ·»åŠ æ•°æ®å¡«å……

```python
# å¦‚æœä»Šå¤©æ²¡æœ‰æ•°æ®ï¼Œä½¿ç”¨æœ€è¿‘çš„æ•°æ®
if not data or len(data["data"]) == 0:
    # å°è¯•è·å–æ›´æ—©çš„æ•°æ®
    start_date = (datetime.now() - timedelta(days=90)).strftime("%Y-%m-%d")
    # é‡æ–°æŸ¥è¯¢
```

### 3. æ·»åŠ æ•°æ®éªŒè¯

```python
# æ£€æŸ¥æ•°æ®æ˜¯å¦è¿‡æœŸ
data_date = datetime.strptime(latest.get("date"), "%Y-%m-%d")
days_old = (datetime.now() - data_date).days
if days_old > 7:
    logger.warning(f"æ•°æ®å·²è¿‡æœŸ {days_old} å¤©")
```

